<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocToWeb Converter</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #e8c547;
    --accent2: #5b8eff;
    --text: #e8e8f0;
    --text-dim: #8888a8;
    --sidebar-w: 290px;
    --radius: 12px;
    --topbar-bg: rgba(13,13,15,0.94);
    --font-scale: 1;
  }
  html.light {
    --bg: #faf8f2;
    --surface: #f2efe6;
    --surface2: #e9e5d8;
    --border: #d4cebc;
    --accent: #7a5c1e;
    --accent2: #2a52b0;
    --text: #18180e;
    --text-dim: #6a6248;
    --topbar-bg: rgba(250,248,242,0.96);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Times New Roman', Times, serif;
    font-style: normal;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.25s, color 0.25s;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UPLOAD SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #upload-screen {
    min-height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 2rem; position: relative; overflow: hidden;
  }
  #upload-screen::before {
    content: ''; position: absolute; inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 20% 30%, rgba(91,142,255,0.09) 0%, transparent 70%),
      radial-gradient(ellipse 50% 40% at 80% 70%, rgba(232,197,71,0.06) 0%, transparent 70%);
    pointer-events: none;
  }
  html.light #upload-screen::before {
    background:
      radial-gradient(ellipse 60% 50% at 20% 30%, rgba(42,82,176,0.05) 0%, transparent 70%),
      radial-gradient(ellipse 50% 40% at 80% 70%, rgba(122,92,30,0.06) 0%, transparent 70%);
  }

  .upload-theme-btn {
    position: absolute; top: 1.25rem; right: 1.25rem;
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); width: 42px; height: 42px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s; z-index: 10;
  }
  .upload-theme-btn:hover { background: var(--surface2); transform: rotate(25deg); }

  .logo {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 700; font-style: normal;
    letter-spacing: -0.02em; margin-bottom: 0.3rem;
    background: linear-gradient(135deg, var(--text) 40%, var(--accent));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .tagline {
    color: var(--text-dim); font-size: 0.88rem; font-style: normal;
    margin-bottom: 2.75rem; letter-spacing: 0.04em;
  }

  /* Drop zone â€” clean minimal */
  .drop-zone {
    width: min(480px, 100%);
    border: 2px dashed var(--border);
    border-radius: 20px; padding: 2.75rem 2rem;
    text-align: center; transition: all 0.3s ease;
    background: var(--surface); position: relative; overflow: hidden;
  }
  .drop-zone::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(91,142,255,0.04), rgba(232,197,71,0.04));
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
  }
  .drop-zone.drag-over {
    border-color: var(--accent2); transform: translateY(-2px);
    box-shadow: 0 20px 60px rgba(91,142,255,0.13);
  }
  .drop-zone.drag-over::after { opacity: 1; }

  .drop-icon {
    width: 60px; height: 60px; margin: 0 auto 1.25rem;
    background: linear-gradient(135deg, var(--accent2), #8b5cf6);
    border-radius: 14px; display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem;
  }
  .drop-title {
    font-size: 1.25rem; font-weight: 700; font-style: normal;
    margin-bottom: 0.4rem; color: var(--text);
  }
  /* File type hint â€” small, subtle */
  .drop-hint {
    color: var(--text-dim); font-size: 0.78rem; font-style: normal;
    margin-bottom: 1.5rem; line-height: 1.5;
  }
  .drop-hint strong { color: var(--text-dim); font-weight: 600; }

  /* Single upload button */
  .btn-upload {
    display: inline-flex; align-items: center; gap: 0.5rem;
    background: var(--accent); color: #0d0d0f;
    border: none; padding: 0.72rem 2rem; border-radius: 8px;
    font-family: 'Times New Roman', Times, serif; font-style: normal;
    font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
  }
  .btn-upload:hover { opacity: 0.88; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(232,197,71,0.28); }

  #file-input { display: none; }

  #progress-bar { display: none; width: min(480px, 100%); margin-top: 1.5rem; }
  .progress-label { color: var(--text-dim); font-size: 0.78rem; font-style: normal; margin-bottom: 0.4rem; }
  .progress-track { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 2px; width: 0%; transition: width 0.3s ease;
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0%,100%{opacity:.75;} 50%{opacity:1;} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VIEWER SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #viewer-screen { display: none; height: 100vh; overflow: hidden; }

  .topbar {
    position: fixed; top: 0; left: 0; right: 0; height: 54px;
    background: var(--topbar-bg); backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 1rem; gap: 0.5rem;
    z-index: 100; transition: background 0.25s, border-color 0.25s;
  }
  .topbar-logo {
    font-weight: 700; font-style: normal; font-size: 1rem;
    color: var(--accent); flex: 1;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* Hamburger â€” always visible */
  .hamburger {
    background: none; border: 1px solid var(--border);
    color: var(--text); cursor: pointer;
    width: 34px; height: 34px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
  }
  .hamburger:hover { background: var(--surface2); border-color: var(--accent2); }
  .hamburger.open { background: var(--surface2); border-color: var(--accent); color: var(--accent); }
  .hamburger svg { display: block; }

  .topbar-actions { display: flex; gap: 0.4rem; align-items: center; flex-shrink: 0; }

  .btn-secondary {
    display: inline-flex; align-items: center; gap: 0.4rem;
    background: var(--surface2); color: var(--text);
    border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 7px;
    font-family: 'Times New Roman', Times, serif; font-style: normal;
    font-size: 0.82rem; cursor: pointer; transition: all 0.2s;
  }
  .btn-secondary:hover { background: var(--border); border-color: var(--accent2); }

  .btn-icon {
    background: none; border: 1px solid var(--border);
    color: var(--text-dim); width: 34px; height: 34px;
    border-radius: 7px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s; flex-shrink: 0;
  }
  .btn-icon:hover { color: var(--text); background: var(--surface2); border-color: var(--accent); }
  .btn-icon.active { color: var(--accent); border-color: var(--accent); background: var(--surface2); }
  .btn-icon svg { transition: transform 0.3s; }
  .btn-icon:hover svg { transform: rotate(40deg); }

  /* â”€â”€â”€ Settings dropdown â”€â”€â”€ */
  .settings-panel {
    position: fixed; top: 58px; right: 1rem;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 0.5rem; min-width: 220px;
    z-index: 300; box-shadow: 0 16px 48px rgba(0,0,0,0.45); display: none;
  }
  .settings-panel.open { display: block; }

  .settings-section { padding: 0 0 0.25rem; }
  .settings-label {
    font-size: 0.64rem; text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--text-dim); padding: 0.5rem 0.75rem 0.3rem; font-style: normal;
    display: block;
  }
  .settings-sep { height: 1px; background: var(--border); margin: 0.3rem 0; }

  .theme-option {
    display: flex; align-items: center; gap: 0.65rem;
    padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer;
    font-size: 0.83rem; color: var(--text-dim);
    border: none; background: none; font-style: normal;
    font-family: 'Times New Roman', Times, serif;
    width: 100%; text-align: left; transition: background 0.15s;
  }
  .theme-option:hover { background: var(--surface2); color: var(--text); }
  .theme-option.active { color: var(--accent); background: var(--surface2); }
  .theme-swatch { width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0; }

  /* Font size control */
  .fontsize-row {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.4rem 0.75rem;
  }
  .fontsize-label {
    font-size: 0.83rem; color: var(--text-dim); font-style: normal;
    font-family: 'Times New Roman', Times, serif; flex: 1;
  }
  .fontsize-btns { display: flex; gap: 4px; }
  .fs-btn {
    width: 28px; height: 28px; border-radius: 5px;
    border: 1px solid var(--border); background: var(--surface2);
    color: var(--text); cursor: pointer; font-size: 0.85rem; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; font-family: sans-serif;
  }
  .fs-btn:hover { background: var(--border); border-color: var(--accent2); color: var(--accent); }
  .fs-display {
    font-size: 0.75rem; color: var(--text-dim); font-style: normal;
    font-family: monospace; min-width: 30px; text-align: center;
  }

  /* â”€â”€â”€ Sidebar â”€â”€â”€ */
  .sidebar-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 49; backdrop-filter: blur(2px);
  }
  .sidebar-overlay.open { display: block; }

  .sidebar {
    position: fixed; top: 54px; left: 0; bottom: 0;
    width: var(--sidebar-w); background: var(--surface);
    border-right: 1px solid var(--border);
    overflow-y: auto; z-index: 50;
    transform: translateX(-100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1), background 0.25s;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 4px 0 24px rgba(0,0,0,0.25);
  }
  @media (min-width: 769px) {
    .sidebar-overlay { display: none !important; }
    .main-content { transition: margin-left 0.28s cubic-bezier(0.4,0,0.2,1); }
    .main-content.pushed { margin-left: var(--sidebar-w); }
  }
  @media (max-width: 768px) {
    .sidebar-overlay.open { display: block; }
    .btn-secondary .btn-label { display: none; }
  }

  .sidebar-header {
    padding: 1.1rem 1.1rem 0.7rem;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-title {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 0.65rem; font-weight: 700; font-style: normal;
    text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim);
  }

  /* â”€â”€â”€ TOC â€” Arial font, bold h1 entries, indented h2 â”€â”€â”€ */
  #toc { padding: 0.6rem 0; }
  #toc a {
    display: block;
    text-decoration: none; font-style: normal;
    transition: all 0.15s; border-left: 2px solid transparent;
    font-family: Arial, Helvetica, sans-serif;
  }
  #toc a:hover { background: var(--surface2); }
  #toc a.active { border-left-color: var(--accent); background: rgba(232,197,71,0.05); }

  /* H1 entries â€” bold, not indented */
  #toc a.toc-h1 {
    padding: 0.38rem 1rem 0.38rem 1rem;
    font-size: 0.8rem; font-weight: 700;
    color: var(--text);
  }
  #toc a.toc-h1:hover { color: var(--accent); }
  #toc a.toc-h1.active { color: var(--accent); }

  /* H2 entries â€” normal weight, indented */
  #toc a.toc-h2 {
    padding: 0.3rem 1rem 0.3rem 1.85rem;
    font-size: 0.75rem; font-weight: 400;
    color: var(--text-dim);
  }
  #toc a.toc-h2:hover { color: var(--text); }
  #toc a.toc-h2.active { color: var(--accent); }

  .toc-empty {
    padding: 1rem 1rem; color: var(--text-dim);
    font-size: 0.78rem; font-style: normal; line-height: 1.5;
    font-family: Arial, Helvetica, sans-serif;
  }

  /* â”€â”€â”€ Main content â”€â”€â”€ */
  .main-content {
    margin-left: 0; margin-top: 54px;
    height: calc(100vh - 54px); overflow-y: auto;
    padding: 3rem clamp(1.5rem, 5vw, 4rem);
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    font-size: calc(1rem * var(--font-scale));
  }
  .content-inner { max-width: 760px; margin: 0 auto; font-style: normal; }

  /* â”€â”€â”€ Doc typography â€” no forced italics â”€â”€â”€ */
  .content-inner h1 {
    font-size: calc(clamp(1.8rem, 4vw, 2.6rem) * var(--font-scale));
    font-weight: 700; font-style: normal;
    line-height: 1.25; margin: 2.5rem 0 1rem; color: var(--text); scroll-margin-top: 80px;
  }
  .content-inner h1:first-child { margin-top: 0; }
  .content-inner h2 {
    font-size: calc(clamp(1.25rem, 2.5vw, 1.7rem) * var(--font-scale));
    font-weight: 700; font-style: normal;
    line-height: 1.3; margin: 2rem 0 0.75rem; color: var(--text); scroll-margin-top: 80px;
  }
  .content-inner h3 {
    font-size: calc(1.15rem * var(--font-scale));
    font-weight: 700; font-style: normal;
    margin: 1.5rem 0 0.5rem; color: var(--accent2); scroll-margin-top: 80px;
  }
  .content-inner h4, .content-inner h5, .content-inner h6 {
    font-weight: 700; font-style: normal;
    margin: 1.25rem 0 0.5rem; color: var(--text); scroll-margin-top: 80px;
  }
  .content-inner em, .content-inner i { font-style: italic; }
  .content-inner p {
    line-height: 1.85; margin-bottom: 1.1rem;
    color: var(--text); font-style: normal;
  }
  .content-inner ul, .content-inner ol {
    margin: 0.75rem 0 1rem 1.75rem; color: var(--text); line-height: 1.8;
  }
  .content-inner li { margin-bottom: 0.3rem; }
  .content-inner strong, .content-inner b { font-weight: 700; }

  .content-inner a { color: var(--accent2); text-decoration: underline; text-underline-offset: 2px; transition: opacity 0.15s; }
  .content-inner a:hover { opacity: 0.72; }
  .content-inner a[href^="#"] { color: var(--accent); text-decoration: none; border-bottom: 1px dashed var(--accent); }
  .content-inner a[href^="#"]:hover { border-bottom-style: solid; }

  .content-inner img {
    max-width: 100%; height: auto; border-radius: var(--radius);
    margin: 1.5rem 0; box-shadow: 0 8px 40px rgba(0,0,0,0.28); display: block;
  }
  .content-inner table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
  .content-inner th {
    background: var(--surface2); padding: 0.7rem 1rem;
    text-align: left; font-weight: 700; font-style: normal;
    border-bottom: 2px solid var(--accent);
  }
  .content-inner td { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); color: var(--text); }
  .content-inner tr:hover td { background: var(--surface2); }
  .content-inner blockquote {
    border-left: 3px solid var(--accent); padding: 0.75rem 1.25rem;
    margin: 1.5rem 0; background: var(--surface2);
    border-radius: 0 var(--radius) var(--radius) 0; color: var(--text-dim);
  }
  .content-inner code {
    background: var(--surface2); padding: 0.15rem 0.4rem;
    border-radius: 4px; font-size: 0.85em; color: var(--accent);
    font-family: 'Courier New', monospace; font-style: normal;
  }
  .content-inner pre {
    background: var(--surface2); padding: 1.25rem;
    border-radius: var(--radius); overflow-x: auto;
    margin: 1.25rem 0; border: 1px solid var(--border);
  }
  .content-inner pre code { background: none; padding: 0; color: var(--text); }
  .content-inner hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }

  /* Static inline TOC block */
  .doc-toc-block {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1.25rem 1.5rem; margin: 1.5rem 0;
  }
  .doc-toc-block p { margin-bottom: 0.25rem; font-style: normal; }

  /* PDF notice badge */
  .pdf-notice {
    display: inline-flex; align-items: center; gap: 0.4rem;
    background: rgba(91,142,255,0.12); border: 1px solid rgba(91,142,255,0.25);
    color: var(--accent2); font-size: 0.75rem; font-style: normal;
    padding: 0.3rem 0.65rem; border-radius: 20px; margin-top: 0.75rem;
    font-family: Arial, Helvetica, sans-serif;
  }

  /* Toast */
  .toast {
    position: fixed; bottom: 1.75rem; right: 1.75rem;
    background: var(--surface2); border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 0.7rem 1.1rem; border-radius: var(--radius);
    font-size: 0.85rem; font-style: normal; z-index: 9999;
    transform: translateY(100px); opacity: 0;
    transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.4); max-width: 320px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  .btn-reset {
    background: none; border: none; color: var(--text-dim);
    cursor: pointer; font-size: 0.78rem; font-style: normal;
    font-family: 'Times New Roman', Times, serif;
    padding: 0.4rem 0.65rem; border-radius: 6px; transition: all 0.2s; white-space: nowrap;
  }
  .btn-reset:hover { color: var(--text); background: var(--surface2); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UPLOAD SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="upload-screen">
  <button class="upload-theme-btn" id="upload-theme-btn" title="Chuyá»ƒn giao diá»‡n sÃ¡ng/tá»‘i">
    <svg id="upload-theme-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
  </button>

  <div class="logo">DocToWeb</div>
  <div class="tagline">Convert Â· Structure Â· Publish</div>

  <div class="drop-zone" id="drop-zone">
    <div class="drop-icon">ğŸ“„</div>
    <div class="drop-title">KÃ©o tháº£ file vÃ o Ä‘Ã¢y</div>
    <div class="drop-hint">Há»— trá»£ <strong>.docx</strong> vÃ  <strong>.pdf</strong></div>
    <button class="btn-upload" id="upload-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Táº£i lÃªn
    </button>
    <input type="file" id="file-input" accept=".docx,.pdf">
  </div>

  <div id="progress-bar">
    <div class="progress-label" id="progress-label">Äang xá»­ lÃ½...</div>
    <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VIEWER SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="viewer-screen">

  <div class="topbar">
    <button class="hamburger" id="hamburger" title="ÄÃ³ng/Má»Ÿ má»¥c lá»¥c">
      <svg id="hamburger-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <div class="topbar-logo" id="topbar-logo">DocToWeb</div>
    <div class="topbar-actions">
      <button class="btn-secondary" onclick="downloadHTML()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span class="btn-label">Táº£i file HTML</span>
      </button>
      <button class="btn-icon" id="settings-btn" title="CÃ i Ä‘áº·t">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </button>
      <button class="btn-reset" onclick="resetApp()">â† File má»›i</button>
    </div>
  </div>

  <!-- Settings panel -->
  <div class="settings-panel" id="settings-panel">
    <!-- Theme section -->
    <div class="settings-section">
      <span class="settings-label">Giao diá»‡n</span>
      <button class="theme-option active" id="opt-dark" onclick="setTheme('dark')">
        <div class="theme-swatch" style="background:#0d0d0f;border:1px solid #555;"></div>
        Cháº¿ Ä‘á»™ tá»‘i
      </button>
      <button class="theme-option" id="opt-light" onclick="setTheme('light')">
        <div class="theme-swatch" style="background:#faf8f2;border:1px solid #bbb;"></div>
        Cháº¿ Ä‘á»™ sÃ¡ng (ná»n kem)
      </button>
    </div>

    <div class="settings-sep"></div>

    <!-- Font size section -->
    <div class="settings-section">
      <span class="settings-label">Cá»¡ chá»¯ ná»™i dung</span>
      <div class="fontsize-row">
        <span class="fontsize-label">KÃ­ch thÆ°á»›c</span>
        <div class="fontsize-btns">
          <button class="fs-btn" onclick="changeFontSize(-1)" title="Giáº£m cá»¡ chá»¯">Aâˆ’</button>
          <span class="fs-display" id="fs-display">100%</span>
          <button class="fs-btn" onclick="changeFontSize(1)" title="TÄƒng cá»¡ chá»¯">A+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header"><div class="sidebar-title">Má»¥c lá»¥c</div></div>
    <div id="toc"></div>
  </nav>

  <main class="main-content" id="main-content">
    <div class="content-inner" id="content-inner"></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let generatedHTML = '';
let currentDocName = 'document';
let currentTheme = 'dark';
let sidebarOpen = false;
let fontScale = 100; // percent, 70â€“160

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTheme(t) {
  currentTheme = t;
  document.documentElement.classList.toggle('light', t === 'light');
  document.getElementById('opt-dark').classList.toggle('active', t === 'dark');
  document.getElementById('opt-light').classList.toggle('active', t === 'light');
  const icon = document.getElementById('upload-theme-icon');
  if (t === 'light') {
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
  } else {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  }
  closeSettings();
}

document.getElementById('upload-theme-btn').addEventListener('click', () => {
  setTheme(currentTheme === 'dark' ? 'light' : 'dark');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FONT SIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeFontSize(dir) {
  // Steps: 70, 80, 90, 100, 110, 120, 135, 150
  const steps = [70, 80, 90, 100, 110, 120, 135, 150];
  let idx = steps.indexOf(fontScale);
  if (idx === -1) idx = steps.findIndex(s => s >= fontScale);
  idx = Math.max(0, Math.min(steps.length - 1, idx + dir));
  fontScale = steps[idx];
  document.documentElement.style.setProperty('--font-scale', fontScale / 100);
  document.getElementById('fs-display').textContent = fontScale + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('settings-btn').addEventListener('click', e => {
  e.stopPropagation();
  const panel = document.getElementById('settings-panel');
  const btn = document.getElementById('settings-btn');
  const open = panel.classList.toggle('open');
  btn.classList.toggle('active', open);
});
function closeSettings() {
  document.getElementById('settings-panel').classList.remove('open');
  document.getElementById('settings-btn').classList.remove('active');
}
document.addEventListener('click', e => {
  const panel = document.getElementById('settings-panel');
  const btn = document.getElementById('settings-btn');
  if (panel.classList.contains('open') && !panel.contains(e.target) && !btn.contains(e.target)) {
    closeSettings();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAMBURGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('hamburger').addEventListener('click', () => {
  sidebarOpen ? closeSidebar() : openSidebar();
});
function openSidebar() {
  sidebarOpen = true;
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('hamburger').classList.add('open');
  if (window.innerWidth > 768) {
    document.getElementById('main-content').classList.add('pushed');
  } else {
    document.getElementById('sidebar-overlay').classList.add('open');
  }
  document.getElementById('hamburger-icon').innerHTML =
    '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
}
function closeSidebar() {
  sidebarOpen = false;
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('hamburger').classList.remove('open');
  document.getElementById('main-content').classList.remove('pushed');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.getElementById('hamburger-icon').innerHTML =
    '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
}
window.addEventListener('resize', () => {
  if (sidebarOpen) {
    if (window.innerWidth > 768) {
      document.getElementById('main-content').classList.add('pushed');
      document.getElementById('sidebar-overlay').classList.remove('open');
    } else {
      document.getElementById('main-content').classList.remove('pushed');
      document.getElementById('sidebar-overlay').classList.add('open');
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAG & DROP + FILE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', e => { if (!dropZone.contains(e.relatedTarget)) dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
  else showToast('âš ï¸ KhÃ´ng nháº­n Ä‘Æ°á»£c file');
});

document.getElementById('upload-btn').addEventListener('click', e => { e.stopPropagation(); fileInput.click(); });
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

function handleFile(file) {
  const name = file.name.toLowerCase();
  if (name.endsWith('.docx')) {
    processDocx(file);
  } else if (name.endsWith('.pdf')) {
    processPdf(file);
  } else {
    showToast('âš ï¸ Chá»‰ há»— trá»£ file .docx hoáº·c .pdf');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE COMPRESSION â€” Base64 permanent embed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function compressImage(blob, maxW = 1400, quality = 0.82) {
  return new Promise((resolve) => {
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      let { width, height } = img;
      if (width > maxW) { height = Math.round(height * maxW / width); width = maxW; }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      const reader = new FileReader();
      reader.onload = ev => resolve(ev.target.result);
      reader.onerror = () => resolve('');
      reader.readAsDataURL(blob);
    };
    img.src = url;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROCESS DOCX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processDocx(file) {
  currentDocName = file.name.replace(/\.docx$/i, '');
  showProgress('Äang Ä‘á»c file DOCX...', 10);
  try {
    const arrayBuffer = await file.arrayBuffer();
    showProgress('Äang chuyá»ƒn Ä‘á»•i + nÃ©n áº£nh...', 30);
    const result = await mammoth.convertToHtml(
      { arrayBuffer },
      {
        convertImage: mammoth.images.imgElement(async (image) => {
          try {
            const imageBuffer = await image.read();
            const contentType = image.contentType || 'image/png';
            const blob = new Blob([imageBuffer], { type: contentType });
            const dataUrl = await compressImage(blob);
            return { src: dataUrl, style: 'max-width:100%;height:auto;' };
          } catch (e) { return { src: '' }; }
        })
      }
    );
    showProgress('Äang xÃ¢y dá»±ng giao diá»‡n...', 75);
    renderViewer(result.value, 'docx');
    finishLoad();
  } catch (err) {
    console.error(err);
    hideProgress();
    showToast('âŒ Lá»—i DOCX: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROCESS PDF â€” extract text via PDF.js CDN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processPdf(file) {
  currentDocName = file.name.replace(/\.pdf$/i, '');
  showProgress('Äang táº£i thÆ° viá»‡n PDF...', 5);

  // Dynamically load PDF.js from CDN
  if (!window.pdfjsLib) {
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  try {
    showProgress('Äang Ä‘á»c file PDF...', 15);
    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const totalPages = pdfDoc.numPages;
    let fullHtml = '';

    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      const pct = Math.round(15 + (pageNum / totalPages) * 65);
      showProgress(`Äang xá»­ lÃ½ trang ${pageNum}/${totalPages}...`, pct);

      const page = await pdfDoc.getPage(pageNum);
      const textContent = await page.getTextContent();

      // Group text items into lines by Y position
      const lines = groupPdfLines(textContent.items);
      // Convert lines to basic HTML
      const pageHtml = pdfLinesToHtml(lines, pageNum, totalPages);
      fullHtml += pageHtml;

      // Render page as image and embed as Base64
      const imgDataUrl = await renderPdfPageAsImage(page, 1400);
      if (imgDataUrl) {
        fullHtml += `<figure style="margin:1.5rem 0;"><img src="${imgDataUrl}" alt="Trang ${pageNum}" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);display:block;"/><figcaption style="font-size:0.75rem;color:var(--text-dim);text-align:center;margin-top:0.4rem;">Trang ${pageNum}</figcaption></figure>`;
      }

      if (pageNum < totalPages) {
        fullHtml += '<hr>';
      }
    }

    showProgress('Äang xÃ¢y dá»±ng giao diá»‡n...', 85);
    renderViewer(fullHtml, 'pdf');
    finishLoad();
  } catch (err) {
    console.error(err);
    hideProgress();
    showToast('âŒ Lá»—i PDF: ' + err.message);
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

// Group PDF text items into lines by Y-coordinate
function groupPdfLines(items) {
  const lineMap = {};
  items.forEach(item => {
    if (!item.str || !item.str.trim()) return;
    const y = Math.round(item.transform[5]); // Y position
    if (!lineMap[y]) lineMap[y] = [];
    lineMap[y].push({ text: item.str, x: item.transform[4], height: item.height || 12 });
  });
  // Sort by Y descending (PDF Y goes up)
  return Object.entries(lineMap)
    .sort((a, b) => Number(b[0]) - Number(a[0]))
    .map(([y, items]) => ({
      y: Number(y),
      text: items.sort((a, b) => a.x - b.x).map(i => i.text).join(' ').trim(),
      height: Math.max(...items.map(i => i.height))
    }))
    .filter(l => l.text);
}

// Convert grouped lines to HTML with basic heading detection
function pdfLinesToHtml(lines, pageNum, totalPages) {
  if (!lines.length) return '';
  const avgHeight = lines.reduce((s, l) => s + l.height, 0) / lines.length;
  let html = '';
  lines.forEach(line => {
    const text = escapeHtmlStr(line.text);
    if (line.height > avgHeight * 1.4 && line.text.length < 120) {
      // Likely a heading
      html += `<h2>${text}</h2>`;
    } else {
      html += `<p>${text}</p>`;
    }
  });
  return html;
}

async function renderPdfPageAsImage(page, maxW = 1400) {
  try {
    const viewport = page.getViewport({ scale: 1 });
    const scale = Math.min(maxW / viewport.width, 2.5);
    const scaledVp = page.getViewport({ scale });
    const canvas = document.createElement('canvas');
    canvas.width = scaledVp.width;
    canvas.height = scaledVp.height;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    await page.render({ canvasContext: ctx, viewport: scaledVp }).promise;
    return canvas.toDataURL('image/jpeg', 0.82);
  } catch (e) { return null; }
}

function escapeHtmlStr(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function finishLoad() {
  document.getElementById('topbar-logo').textContent = 'DocToWeb â€” ' + currentDocName;
  showProgress('HoÃ n táº¥t!', 100);
  setTimeout(() => {
    document.getElementById('upload-screen').style.display = 'none';
    document.getElementById('viewer-screen').style.display = 'block';
    showToast('âœ… Chuyá»ƒn Ä‘á»•i thÃ nh cÃ´ng!');
  }, 380);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function slugify(text) {
  return (text || '').toLowerCase()
    .replace(/[Ã Ã¡áº¡áº£Ã£Ã¢áº§áº¥áº­áº©áº«Äƒáº±áº¯áº·áº³áºµ]/g,'a').replace(/[Ã¨Ã©áº¹áº»áº½Ãªá»áº¿á»‡á»ƒá»…]/g,'e')
    .replace(/[Ã¬Ã­á»‹á»‰Ä©]/g,'i').replace(/[Ã²Ã³á»á»ÃµÃ´á»“á»‘á»™á»•á»—Æ¡á»á»›á»£á»Ÿá»¡]/g,'o')
    .replace(/[Ã¹Ãºá»¥á»§Å©Æ°á»«á»©á»±á»­á»¯]/g,'u').replace(/[á»³Ã½á»µá»·á»¹]/g,'y').replace(/Ä‘/g,'d')
    .replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-').replace(/-+/g,'-') || 'section';
}

function renderViewer(html, type) {
  const ci = document.getElementById('content-inner');
  ci.innerHTML = html;

  // External links â†’ new tab
  ci.querySelectorAll('a[href]').forEach(a => {
    const href = a.getAttribute('href') || '';
    if (!href.startsWith('#')) {
      a.setAttribute('target', '_blank');
      a.setAttribute('rel', 'noopener noreferrer');
    }
  });

  // Static TOC detection (Word docs only)
  if (type === 'docx') processInlineTOC(ci);

  // ID headings
  const headings = ci.querySelectorAll('h1, h2, h3');
  const idCount = {};
  headings.forEach(h => {
    const base = slugify(h.textContent);
    idCount[base] = (idCount[base] || 0) + 1;
    h.id = idCount[base] > 1 ? `${base}-${idCount[base]}` : base;
  });

  buildSidebarTOC(ci);
  generatedHTML = ci.innerHTML;
  setupScrollSpy();
}

function processInlineTOC(ci) {
  const paras = Array.from(ci.querySelectorAll('p'));
  const isTOCLine = (p) => {
    const t = p.textContent.trim();
    return /\.{3,}\s*\d+\s*$/.test(t) || /\t\d+\s*$/.test(t);
  };
  let tocStart = -1, tocEnd = -1;
  for (let i = 0; i < paras.length; i++) {
    if (isTOCLine(paras[i])) {
      if (tocStart === -1) tocStart = i;
      tocEnd = i;
    } else if (tocStart !== -1 && (i - tocEnd) > 2) break;
  }
  if (tocStart !== -1 && tocEnd - tocStart >= 2) {
    const tocParas = paras.slice(tocStart, tocEnd + 1);
    const wrapper = document.createElement('div');
    wrapper.className = 'doc-toc-block';
    tocParas[0].parentNode.insertBefore(wrapper, tocParas[0]);
    tocParas.forEach(p => {
      const clone = p.cloneNode(true);
      clone.querySelectorAll('a').forEach(a => {
        const span = document.createElement('span');
        span.innerHTML = a.innerHTML; a.replaceWith(span);
      });
      clone.innerHTML = clone.innerHTML
        .replace(/\.{3,}\s*\d+(\s*(<\/[^>]+>)*)?\s*$/, '$2')
        .replace(/\t\s*\d+\s*$/, '');
      wrapper.appendChild(clone); p.remove();
    });
  }
}

function buildSidebarTOC(ci) {
  const toc = document.getElementById('toc');
  const headings = ci.querySelectorAll('h1, h2');
  toc.innerHTML = '';
  if (!headings.length) {
    toc.innerHTML = '<div class="toc-empty">KhÃ´ng tÃ¬m tháº¥y Heading 1/2.<br>Trong Google Docs/Word hÃ£y dÃ¹ng Ä‘á»‹nh dáº¡ng Heading.</div>';
    return;
  }
  headings.forEach(h => {
    const a = document.createElement('a');
    a.href = '#' + h.id;
    a.textContent = h.textContent;
    a.className = h.tagName === 'H2' ? 'toc-h2' : 'toc-h1';
    a.addEventListener('click', ev => {
      ev.preventDefault();
      const el = document.getElementById(h.id);
      if (el) {
        const mc = document.getElementById('main-content');
        mc.scrollTo({ top: el.offsetTop - 72, behavior: 'smooth' });
      }
      if (window.innerWidth <= 768) closeSidebar();
    });
    toc.appendChild(a);
  });
}

function setupScrollSpy() {
  const mc = document.getElementById('main-content');
  const ci = document.getElementById('content-inner');
  mc.addEventListener('scroll', () => {
    const st = mc.scrollTop + 80;
    const hs = ci.querySelectorAll('h1, h2');
    let active = null;
    hs.forEach(h => { if (h.offsetTop <= st) active = h.id; });
    document.querySelectorAll('#toc a').forEach(a => {
      a.classList.toggle('active', a.getAttribute('href') === '#' + active);
    });
  }, { passive: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOWNLOAD HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function downloadHTML() {
  const tocHTML = document.getElementById('toc').innerHTML;
  const isLight = currentTheme === 'light';
  const docName = currentDocName;
  const fScale = fontScale;

  const out = `<!DOCTYPE html>
<html lang="vi" class="${isLight ? 'light' : ''}">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${esc(docName)}</title>
<style>
:root{--bg:#0d0d0f;--surface:#16161a;--surface2:#1e1e24;--border:#2a2a35;--accent:#e8c547;--accent2:#5b8eff;--text:#e8e8f0;--text-dim:#8888a8;--sidebar-w:290px;--radius:12px;--topbar-bg:rgba(13,13,15,0.94);--font-scale:${fScale/100};}
html.light{--bg:#faf8f2;--surface:#f2efe6;--surface2:#e9e5d8;--border:#d4cebc;--accent:#7a5c1e;--accent2:#2a52b0;--text:#18180e;--text-dim:#6a6248;--topbar-bg:rgba(250,248,242,0.96);}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Times New Roman',Times,serif;font-style:normal;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .25s,color .25s;}
.topbar{position:fixed;top:0;left:0;right:0;height:54px;background:var(--topbar-bg);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 1rem;gap:.5rem;z-index:100;}
.topbar-logo{font-weight:700;font-style:normal;font-size:1rem;color:var(--accent);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hamburger{background:none;border:1px solid var(--border);color:var(--text);cursor:pointer;width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.hamburger:hover{background:var(--surface2);border-color:var(--accent2);}
.hamburger.open{background:var(--surface2);border-color:var(--accent);color:var(--accent);}
.topbar-actions{display:flex;gap:.4rem;align-items:center;flex-shrink:0;}
.btn-icon{background:none;border:1px solid var(--border);color:var(--text-dim);width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;}
.btn-icon:hover{color:var(--text);background:var(--surface2);border-color:var(--accent);}
.btn-icon.active{color:var(--accent);border-color:var(--accent);background:var(--surface2);}
.settings-panel{position:fixed;top:58px;right:1rem;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.5rem;min-width:220px;z-index:300;box-shadow:0 16px 48px rgba(0,0,0,.45);display:none;}
.settings-panel.open{display:block;}
.settings-sep{height:1px;background:var(--border);margin:.3rem 0;}
.settings-label{font-size:.64rem;text-transform:uppercase;letter-spacing:.12em;color:var(--text-dim);padding:.5rem .75rem .3rem;font-style:normal;display:block;}
.theme-option{display:flex;align-items:center;gap:.65rem;padding:.5rem .75rem;border-radius:6px;cursor:pointer;font-size:.83rem;color:var(--text-dim);border:none;background:none;font-style:normal;font-family:'Times New Roman',Times,serif;width:100%;text-align:left;transition:background .15s;}
.theme-option:hover{background:var(--surface2);color:var(--text);}
.theme-option.active{color:var(--accent);background:var(--surface2);}
.theme-swatch{width:16px;height:16px;border-radius:4px;flex-shrink:0;}
.fontsize-row{display:flex;align-items:center;gap:.5rem;padding:.4rem .75rem;}
.fontsize-label{font-size:.83rem;color:var(--text-dim);font-style:normal;font-family:'Times New Roman',Times,serif;flex:1;}
.fontsize-btns{display:flex;gap:4px;}
.fs-btn{width:28px;height:28px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer;font-size:.85rem;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:sans-serif;}
.fs-btn:hover{background:var(--border);border-color:var(--accent2);color:var(--accent);}
.fs-display{font-size:.75rem;color:var(--text-dim);font-style:normal;font-family:monospace;min-width:30px;text-align:center;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:49;backdrop-filter:blur(2px);}
.sidebar-overlay.open{display:block;}
.sidebar{position:fixed;top:54px;left:0;bottom:0;width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;z-index:50;transform:translateX(-100%);transition:transform .28s cubic-bezier(.4,0,.2,1);scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.sidebar.open{transform:translateX(0);box-shadow:4px 0 24px rgba(0,0,0,.25);}
@media(min-width:769px){.sidebar-overlay{display:none !important;}.main-content{transition:margin-left .28s cubic-bezier(.4,0,.2,1);}.main-content.pushed{margin-left:var(--sidebar-w);}}
@media(max-width:768px){.sidebar-overlay.open{display:block;}}
.sidebar-header{padding:1.1rem 1.1rem .7rem;border-bottom:1px solid var(--border);}
.sidebar-title{font-family:Arial,Helvetica,sans-serif;font-size:.65rem;font-weight:700;font-style:normal;text-transform:uppercase;letter-spacing:.12em;color:var(--text-dim);}
#toc{padding:.6rem 0;}
#toc a{display:block;text-decoration:none;font-style:normal;transition:all .15s;border-left:2px solid transparent;font-family:Arial,Helvetica,sans-serif;}
#toc a:hover{background:var(--surface2);}
#toc a.active{border-left-color:var(--accent);background:rgba(232,197,71,.05);}
#toc a.toc-h1{padding:.38rem 1rem;font-size:.8rem;font-weight:700;color:var(--text);}
#toc a.toc-h1:hover,#toc a.toc-h1.active{color:var(--accent);}
#toc a.toc-h2{padding:.3rem 1rem .3rem 1.85rem;font-size:.75rem;font-weight:400;color:var(--text-dim);}
#toc a.toc-h2:hover,#toc a.toc-h2.active{color:var(--accent);}
.main-content{margin-left:0;margin-top:54px;height:calc(100vh - 54px);overflow-y:auto;padding:3rem clamp(1.5rem,5vw,4rem);scrollbar-width:thin;scrollbar-color:var(--border) transparent;font-size:calc(1rem * var(--font-scale));}
.content-inner{max-width:760px;margin:0 auto;font-style:normal;}
.content-inner h1{font-size:calc(clamp(1.8rem,4vw,2.6rem)*var(--font-scale));font-weight:700;font-style:normal;line-height:1.25;margin:2.5rem 0 1rem;color:var(--text);scroll-margin-top:80px;}
.content-inner h1:first-child{margin-top:0;}
.content-inner h2{font-size:calc(clamp(1.25rem,2.5vw,1.7rem)*var(--font-scale));font-weight:700;font-style:normal;line-height:1.3;margin:2rem 0 .75rem;color:var(--text);scroll-margin-top:80px;}
.content-inner h3{font-size:calc(1.15rem*var(--font-scale));font-weight:700;font-style:normal;margin:1.5rem 0 .5rem;color:var(--accent2);scroll-margin-top:80px;}
.content-inner h4,.content-inner h5,.content-inner h6{font-weight:700;font-style:normal;margin:1.25rem 0 .5rem;color:var(--text);}
.content-inner em,.content-inner i{font-style:italic;}
.content-inner strong,.content-inner b{font-weight:700;}
.content-inner p{line-height:1.85;margin-bottom:1.1rem;color:var(--text);font-style:normal;}
.content-inner ul,.content-inner ol{margin:.75rem 0 1rem 1.75rem;color:var(--text);line-height:1.8;}
.content-inner li{margin-bottom:.3rem;}
.content-inner a{color:var(--accent2);text-decoration:underline;text-underline-offset:2px;}
.content-inner a:hover{opacity:.72;}
.content-inner a[href^="#"]{color:var(--accent);text-decoration:none;border-bottom:1px dashed var(--accent);}
.content-inner img{max-width:100%;height:auto;border-radius:12px;margin:1.5rem 0;box-shadow:0 8px 40px rgba(0,0,0,.28);display:block;}
.content-inner table{width:100%;border-collapse:collapse;margin:1.5rem 0;}
.content-inner th{background:var(--surface2);padding:.7rem 1rem;text-align:left;font-weight:700;font-style:normal;border-bottom:2px solid var(--accent);}
.content-inner td{padding:.6rem 1rem;border-bottom:1px solid var(--border);color:var(--text);}
.content-inner tr:hover td{background:var(--surface2);}
.content-inner blockquote{border-left:3px solid var(--accent);padding:.75rem 1.25rem;margin:1.5rem 0;background:var(--surface2);border-radius:0 12px 12px 0;color:var(--text-dim);}
.content-inner code{background:var(--surface2);padding:.15rem .4rem;border-radius:4px;font-size:.85em;color:var(--accent);font-family:'Courier New',monospace;font-style:normal;}
.content-inner pre{background:var(--surface2);padding:1.25rem;border-radius:12px;overflow-x:auto;margin:1.25rem 0;border:1px solid var(--border);}
.content-inner pre code{background:none;padding:0;color:var(--text);}
.content-inner hr{border:none;border-top:1px solid var(--border);margin:2rem 0;}
.doc-toc-block{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:1.25rem 1.5rem;margin:1.5rem 0;}
.doc-toc-block p{margin-bottom:.25rem;font-style:normal;}
</style>
</head>
<body>
<div class="topbar">
  <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
    <svg id="hamburger-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>
  <div class="topbar-logo">DocToWeb â€” ${esc(docName)}</div>
  <div class="topbar-actions">
    <button class="btn-icon" id="settings-btn" onclick="toggleSettingsPanel()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    </button>
  </div>
</div>
<div class="settings-panel" id="settings-panel">
  <span class="settings-label">Giao diá»‡n</span>
  <button class="theme-option ${isLight?'':'active'}" onclick="applyTheme('dark',this)"><div class="theme-swatch" style="background:#0d0d0f;border:1px solid #555;"></div>Cháº¿ Ä‘á»™ tá»‘i</button>
  <button class="theme-option ${isLight?'active':''}" onclick="applyTheme('light',this)"><div class="theme-swatch" style="background:#faf8f2;border:1px solid #bbb;"></div>Cháº¿ Ä‘á»™ sÃ¡ng (ná»n kem)</button>
  <div class="settings-sep"></div>
  <span class="settings-label">Cá»¡ chá»¯ ná»™i dung</span>
  <div class="fontsize-row">
    <span class="fontsize-label">KÃ­ch thÆ°á»›c</span>
    <div class="fontsize-btns">
      <button class="fs-btn" onclick="chgFs(-1)">Aâˆ’</button>
      <span class="fs-display" id="fs-display">${fScale}%</span>
      <button class="fs-btn" onclick="chgFs(1)">A+</button>
    </div>
  </div>
</div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header"><div class="sidebar-title">Má»¥c lá»¥c</div></div>
  <div id="toc">${tocHTML}</div>
</nav>
<main class="main-content" id="main-content">
  <div class="content-inner" id="content-inner">
${generatedHTML}
  </div>
</main>
<script>
var _sb=false,_fs=${fScale};
var _fsSteps=[70,80,90,100,110,120,135,150];
function toggleSidebar(){_sb?closeSidebar():openSidebar();}
function openSidebar(){_sb=true;document.getElementById('sidebar').classList.add('open');document.getElementById('hamburger').classList.add('open');if(window.innerWidth>768){document.getElementById('main-content').classList.add('pushed');}else{document.getElementById('sidebar-overlay').classList.add('open');}document.getElementById('hamburger-icon').innerHTML='<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';}
function closeSidebar(){_sb=false;document.getElementById('sidebar').classList.remove('open');document.getElementById('hamburger').classList.remove('open');document.getElementById('main-content').classList.remove('pushed');document.getElementById('sidebar-overlay').classList.remove('open');document.getElementById('hamburger-icon').innerHTML='<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';}
window.addEventListener('resize',function(){if(_sb){if(window.innerWidth>768){document.getElementById('main-content').classList.add('pushed');document.getElementById('sidebar-overlay').classList.remove('open');}else{document.getElementById('main-content').classList.remove('pushed');document.getElementById('sidebar-overlay').classList.add('open');}}});
function toggleSettingsPanel(){var p=document.getElementById('settings-panel');var b=document.getElementById('settings-btn');var o=p.classList.toggle('open');b.classList.toggle('active',o);}
function applyTheme(t,btn){document.documentElement.classList.toggle('light',t==='light');document.querySelectorAll('.theme-option').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');document.getElementById('settings-panel').classList.remove('open');document.getElementById('settings-btn').classList.remove('active');}
function chgFs(dir){var idx=_fsSteps.indexOf(_fs);if(idx===-1)idx=_fsSteps.findIndex(function(s){return s>=_fs;});idx=Math.max(0,Math.min(_fsSteps.length-1,idx+dir));_fs=_fsSteps[idx];document.documentElement.style.setProperty('--font-scale',_fs/100);document.getElementById('fs-display').textContent=_fs+'%';}
document.addEventListener('click',function(e){var p=document.getElementById('settings-panel');var b=document.getElementById('settings-btn');if(p.classList.contains('open')&&!p.contains(e.target)&&!b.contains(e.target)){p.classList.remove('open');b.classList.remove('active');}});
(function(){
  var mc=document.getElementById('main-content');
  var ci=document.getElementById('content-inner');
  document.querySelectorAll('#toc a').forEach(function(a){
    a.addEventListener('click',function(e){
      e.preventDefault();
      var id=a.getAttribute('href').slice(1);
      var el=document.getElementById(id);
      if(el){mc.scrollTo({top:el.offsetTop-72,behavior:'smooth'});}
      if(window.innerWidth<=768) closeSidebar();
    });
  });
  mc.addEventListener('scroll',function(){
    var st=mc.scrollTop+80;
    var hs=ci.querySelectorAll('h1,h2');
    var active=null;
    hs.forEach(function(h){if(h.offsetTop<=st)active=h.id;});
    document.querySelectorAll('#toc a').forEach(function(a){a.classList.toggle('active',a.getAttribute('href')==='#'+active);});
  },{passive:true});
})();
<\/script>
</body>
</html>`;

  const blob = new Blob([out], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = docName + '.html'; a.click();
  URL.revokeObjectURL(url);
  showToast('ğŸ“¥ ÄÃ£ táº£i file HTML!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetApp() {
  document.getElementById('upload-screen').style.display = 'flex';
  document.getElementById('viewer-screen').style.display = 'none';
  document.getElementById('content-inner').innerHTML = '';
  document.getElementById('toc').innerHTML = '';
  document.getElementById('file-input').value = '';
  hideProgress();
  document.getElementById('progress-fill').style.width = '0%';
  generatedHTML = '';
  if (sidebarOpen) closeSidebar();
}

function showProgress(label, pct) {
  document.getElementById('progress-bar').style.display = 'block';
  document.getElementById('progress-label').textContent = label;
  document.getElementById('progress-fill').style.width = pct + '%';
}
function hideProgress() { document.getElementById('progress-bar').style.display = 'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3200);
}
</script>
</body>
</html>
